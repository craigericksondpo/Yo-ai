# 6. Runtime integration: ensure every executor emits the unhandled exception event
# To actually trigger this chain, you need platform level hooks.
# 6.1 Executor / runtime policy stub
# runtime-policies/unhandled-exception-emission.yaml
policy_id: runtime.unhandled_exception_emission.v1
description: >
  All executors must emit platform.unhandled_exception.detected on any unhandled exception or
  catch-all handler invocation.

applies_to:
  - executor_type: "workflow-engine"
  - executor_type: "python-sandbox"
  - executor_type: "js-sandbox"
  - executor_type: "agent-runner"

rules:
  - id: emit-on-unhandled-exception
    trigger: "unhandled_exception"
    action:
      type: "emit_event"
      event_type: "platform.unhandled_exception.detected"
      payload_mapping:
        execution_id: "{{ runtime.execution_id }}"
        runtime: "{{ runtime.metadata }}"
        origin: "{{ runtime.origin }}"
        exception: "{{ runtime.exception }}"
        severity: "{{ classify_severity(runtime.exception) }}"
        recovery_capability: "{{ infer_recovery_capability(runtime.exception) }}"
        context: "{{ runtime.context | redact_sensitive() }}"
        trace_links: "{{ runtime.trace_links }}"
        emitter_policy_hash: "{{ policy_hash('runtime.unhandled_exception_emission.v1') }}"