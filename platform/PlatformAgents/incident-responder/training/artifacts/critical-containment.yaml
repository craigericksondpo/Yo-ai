# 5.2 Critical containment workflow (including platform shutdown)
# workflows/incident-responder/critical-containment.yaml
workflow_id: incident_responder.workflow.critical_containment.v1
description: "Handle critical unhandled exceptions that may require platform shutdown."

inputs:
  - name: incident_id
    type: string
  - name: context
    type: object
  - name: risk_actions
    type: object

steps:
  - id: local-containment
    type: subworkflow
    workflow_id: incident_responder.workflow.local_containment.v1
    inputs:
      incident_id: "{{ inputs.incident_id }}"
      context: "{{ inputs.context }}"
      risk_actions: "{{ inputs.risk_actions }}"

  - id: evaluate-platform-risk
    type: task
    agent: platform.risk.assessor
    inputs:
      context: "{{ inputs.context }}"
      risk_actions: "{{ inputs.risk_actions }}"
    outputs:
      requires_shutdown: requires_shutdown
      requires_restart: requires_restart

  - id: maybe-shutdown-platform
    type: task
    agent: platform.controller
    when: 'outputs.requires_shutdown == true'
    inputs:
      action: "shutdown_platform"
      reason: "Critical unhandled exception; see incident {{ inputs.incident_id }}"
    outputs:
      shutdown_result: shutdown_result

  - id: maybe-restart-platform
    type: task
    agent: platform.controller
    when: 'outputs.requires_restart == true'
    inputs:
      action: "restart_platform"
      reason: "Critical unhandled exception; see incident {{ inputs.incident_id }}"
    outputs:
      restart_result: restart_result

  - id: log-critical-containment
    type: task
    agent: incident.logger
    inputs:
      incident_id: "{{ inputs.incident_id }}"
      actions:
        local_containment: "{{ steps.local-containment.outputs.local_actions }}"
        shutdown: "{{ outputs.shutdown_result | default(null) }}"
        restart: "{{ outputs.restart_result | default(null) }}"
    outputs:
      critical_actions: actions

  - id: completion
    type: end
    outputs:
      critical_actions: "{{ outputs.critical_actions }}"