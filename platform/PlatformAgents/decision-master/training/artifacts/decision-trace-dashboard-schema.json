// Dashboard schema for visualizing decision paths
// Think of this as the contract for a “Decision Trace Explorer” dashboard. Backed by ClickHouse/Timeseries + materialized views from Kafka.
{
  "version": "1.0",
  "kind": "DashboardDefinition",
  "metadata": {
    "name": "decision-trace-explorer",
    "title": "Decision Trace Explorer",
    "description": "Visualize Decision-Master workflows, risk scores, and access-rights decisions."
  },
  "filters": [
    {
      "id": "time_range",
      "type": "time-range",
      "default": "last_7_days"
    },
    {
      "id": "decision_type",
      "type": "multi-select",
      "label": "Decision Type",
      "options": ["approval", "denial", "partial-approval"],
      "default": ["approval", "denial", "partial-approval"]
    },
    {
      "id": "target_agent",
      "type": "search",
      "label": "Target Registered Agent ID"
    },
    {
      "id": "risk_bucket",
      "type": "multi-select",
      "label": "Risk Bucket",
      "options": ["low", "medium", "high"]
    }
  ],
  "panels": [
    {
      "id": "decision_volume_over_time",
      "type": "time-series",
      "title": "Decision Volume Over Time",
      "query_ref": "q_decision_volume",
      "dimensions": ["decision_type"],
      "filters_applied": ["time_range", "decision_type"]
    },
    {
      "id": "risk_distribution",
      "type": "histogram",
      "title": "Risk Score Distribution",
      "query_ref": "q_risk_scores",
      "filters_applied": ["time_range"]
    },
    {
      "id": "decision_outcomes_by_agent",
      "type": "table",
      "title": "Decision Outcomes by Target Agent",
      "query_ref": "q_outcomes_by_agent",
      "columns": [
        "target_registered_agent_id",
        "total_decisions",
        "approvals",
        "denials",
        "partial_approvals",
        "avg_risk_score"
      ],
      "filters_applied": ["time_range", "decision_type"]
    },
    {
      "id": "decision_path_graph",
      "type": "dag-view",
      "title": "Decision Path for Selected Trace",
      "query_ref": "q_single_trace_steps",
      "inputs": {
        "event_id_param": "selected_event_id"
      }
    },
    {
      "id": "recent_high_risk_denials",
      "type": "table",
      "title": "Recent High-Risk Denials",
      "query_ref": "q_high_risk_denials",
      "columns": [
        "timestamp",
        "event_id",
        "request_id",
        "target_registered_agent_id",
        "risk_score",
        "denied_rights",
        "reason_summary"
      ],
      "filters_applied": ["time_range"]
    }
  ],
  "queries": {
    "q_decision_volume": {
      "source": "decision_trace_index",
      "group_by": ["time_bucket_1h", "final_decision.decision"],
      "metrics": [
        {
          "name": "count",
          "aggregation": "count"
        }
      ]
    },
    "q_risk_scores": {
      "source": "decision_trace_steps_index",
      "filter": "action = 'risk-evaluation'",
      "metrics": [
        {
          "name": "risk_score",
          "field": "outputs.risk_score"
        }
      ]
    },
    "q_outcomes_by_agent": {
      "source": "decision_trace_index",
      "group_by": ["request.target_registered_agent_id"],
      "metrics": [
        { "name": "total_decisions", "aggregation": "count" },
        {
          "name": "approvals",
          "aggregation": "sum",
          "condition": "final_decision.decision = 'approval'"
        },
        {
          "name": "denials",
          "aggregation": "sum",
          "condition": "final_decision.decision = 'denial'"
        },
        {
          "name": "partial_approvals",
          "aggregation": "sum",
          "condition": "final_decision.decision = 'partial-approval'"
        },
        {
          "name": "avg_risk_score",
          "aggregation": "avg",
          "field": "max_risk_score"
        }
      ]
    },
    "q_single_trace_steps": {
      "source": "decision_trace_steps_index",
      "filter": "event_id = :selected_event_id",
      "projection": [
        "step",
        "action",
        "timestamp",
        "inputs",
        "outputs"
      ]
    },
    "q_high_risk_denials": {
      "source": "decision_trace_index",
      "filter": "final_decision.decision = 'denial' AND max_risk_score >= 0.7",
      "projection": [
        "timestamp",
        "event_id",
        "request.request_id",
        "request.target_registered_agent_id",
        "max_risk_score AS risk_score",
        "final_decision.denied_rights",
        "denial_reason_summary"
      ]
    }
  }
}